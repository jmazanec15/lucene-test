# Stage to build lucene and luceneutil
FROM eclipse-temurin:23 as build

ARG TEST_REPO
ARG TEST_BRANCH
ARG LUCENEUTIL_REPO

COPY ./build-lucene.sh /
COPY ./build-luceneutil.sh /

RUN bash /build-lucene.sh ${TEST_REPO} ${TEST_BRANCH}
RUN bash /build-luceneutil.sh ${LUCENEUTIL_REPO}

# Build the actual image
FROM eclipse-temurin:23
USER root
RUN yum install -y unzip procps ant git && rm -rf /var/cache/yum
COPY --from=build /lucene /lucene
COPY --from=build /luceneutil /luceneutil
COPY custom-entrypoint.sh /custom-entrypoint.sh
COPY utils/process-stats-collector.sh /process-stats-collector.sh

ENTRYPOINT ["/bin/bash", "/custom-entrypoint.sh"]
